import type { RegistryEntry } from "../schema";

const componentContent = "import {\n  Combobox as AriaCombobox,\n  ComboboxCancel,\n  ComboboxItem,\n  ComboboxPopover,\n  ComboboxProvider,\n  type ComboboxProps as AriaComboboxProps,\n} from \"@ariakit/react\";\nimport { cva, type VariantProps } from \"class-variance-authority\";\nimport {\n  forwardRef,\n  startTransition,\n  useMemo,\n  useState,\n  type ReactNode,\n} from \"react\";\nimport { cn } from \"../../lib/utils\";\n\nconst comboboxVariants = cva(\n  [\n    \"w-full max-w-md rounded-lg border px-3 py-2\",\n    \"text-sm font-medium\",\n    \"transition-all duration-200\",\n    \"focus:outline-none focus:ring-2 focus:ring-primary-600 focus:ring-offset-2\",\n    \"disabled:cursor-not-allowed disabled:opacity-50\",\n    \"placeholder:text-gray-400 dark:placeholder:text-gray-500\",\n  ],\n  {\n    variants: {\n      variant: {\n        default: [\n          \"bg-white dark:bg-gray-900\",\n          \"border-gray-300 dark:border-gray-700\",\n          \"text-gray-900 dark:text-gray-100\",\n          \"hover:border-gray-400 dark:hover:border-gray-600\",\n        ],\n        outline: [\n          \"bg-transparent\",\n          \"border-primary-600 dark:border-primary-500\",\n          \"text-gray-900 dark:text-gray-100\",\n          \"hover:bg-primary-50 dark:hover:bg-primary-950\",\n        ],\n      },\n      size: {\n        sm: \"h-9 text-sm\",\n        md: \"h-10 text-base\",\n        lg: \"h-11 text-lg\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"md\",\n    },\n  },\n);\n\nconst comboboxItemVariants = cva(\n  [\n    \"flex items-center gap-2 px-3 py-2 rounded-md\",\n    \"text-sm cursor-pointer\",\n    \"transition-colors duration-150\",\n    \"outline-none\",\n  ],\n  {\n    variants: {\n      variant: {\n        default: [\n          \"text-gray-900 dark:text-gray-100\",\n          \"hover:bg-gray-100 dark:hover:bg-gray-800\",\n          \"data-[active-item]:bg-primary-100 dark:data-[active-item]:bg-primary-900\",\n          \"data-[active-item]:text-primary-900 dark:data-[active-item]:text-primary-100\",\n        ],\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  },\n);\n\nexport interface ComboboxOption {\n  value: string;\n  label?: ReactNode;\n  disabled?: boolean;\n}\n\nexport interface ComboboxProps\n  extends\n    Omit<AriaComboboxProps, \"size\" | \"onSelect\">,\n    VariantProps<typeof comboboxVariants> {\n  /** Combobox label */\n  label?: string;\n  /** Options to display in the dropdown */\n  options?: ComboboxOption[];\n  /** Placeholder text */\n  placeholder?: string;\n  /** Show clear button when value is not empty */\n  showClear?: boolean;\n  /** Filter function for options */\n  filterFn?: (\n    options: ComboboxOption[],\n    searchValue: string,\n  ) => ComboboxOption[];\n  /** Callback when value changes */\n  onValueChange?: (value: string) => void;\n  /** Callback when an option is selected */\n  onSelectOption?: (value: string) => void;\n  /** Empty state message */\n  emptyMessage?: string;\n  /** Custom render for items */\n  renderItem?: (option: ComboboxOption) => ReactNode;\n}\n\nexport const Combobox = forwardRef<HTMLInputElement, ComboboxProps>(\n  (\n    {\n      label,\n      options = [],\n      placeholder,\n      showClear = true,\n      filterFn,\n      onValueChange,\n      onSelectOption,\n      emptyMessage = \"No results found\",\n      renderItem,\n      variant,\n      size,\n      className,\n      ...props\n    },\n    ref,\n  ) => {\n    const [searchValue, setSearchValue] = useState(\"\");\n\n    // Default filter function using simple includes\n    const defaultFilterFn = (\n      opts: ComboboxOption[],\n      search: string,\n    ): ComboboxOption[] => {\n      if (!search) return opts;\n      return opts.filter((opt) =>\n        opt.value.toLowerCase().includes(search.toLowerCase()),\n      );\n    };\n\n    const filteredOptions = useMemo(() => {\n      const filterFunc = filterFn || defaultFilterFn;\n      return filterFunc(options, searchValue);\n    }, [options, searchValue, filterFn]);\n\n    return (\n      <ComboboxProvider\n        setValue={(value) => {\n          startTransition(() => {\n            setSearchValue(value);\n            onValueChange?.(value);\n          });\n        }}\n      >\n        <div className=\"w-full space-y-2\">\n          {label && (\n            <label className=\"text-sm font-medium text-gray-900 dark:text-gray-100\">\n              {label}\n            </label>\n          )}\n          <div className=\"relative\">\n            <AriaCombobox\n              ref={ref}\n              placeholder={placeholder}\n              className={cn(comboboxVariants({ variant, size, className }))}\n              {...props}\n            />\n            {showClear && searchValue && (\n              <ComboboxCancel className=\"absolute right-2 top-1/2 -translate-y-1/2 flex items-center justify-center rounded-md p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition-colors\">\n                <svg\n                  width=\"12\"\n                  height=\"12\"\n                  viewBox=\"0 0 12 12\"\n                  fill=\"none\"\n                  stroke=\"currentColor\"\n                  strokeWidth=\"2\"\n                  strokeLinecap=\"round\"\n                >\n                  <path d=\"M4 4l8 8M12 4l-8 8\" />\n                </svg>\n              </ComboboxCancel>\n            )}\n          </div>\n          <ComboboxPopover\n            gutter={8}\n            sameWidth\n            className={cn(\n              \"z-50 max-h-80 overflow-auto rounded-lg border bg-white p-1 shadow-lg dark:bg-gray-900 dark:border-gray-700\",\n              \"opacity-0 transition-all duration-200 ease-out\",\n              \"data-enter:opacity-100 data-enter:translate-y-0\",\n              \"data-leave:opacity-0 data-leave:-translate-y-1\",\n            )}\n          >\n            {filteredOptions.length > 0 ? (\n              filteredOptions.map((option) => (\n                <ComboboxItem\n                  key={option.value}\n                  value={option.value}\n                  disabled={option.disabled}\n                  onClick={() => onSelectOption?.(option.value)}\n                  className={comboboxItemVariants()}\n                >\n                  {renderItem\n                    ? renderItem(option)\n                    : option.label || option.value}\n                </ComboboxItem>\n              ))\n            ) : (\n              <div className=\"px-3 py-2 text-center text-sm text-gray-500 dark:text-gray-400\">\n                {emptyMessage}\n              </div>\n            )}\n          </ComboboxPopover>\n        </div>\n      </ComboboxProvider>\n    );\n  },\n);\n\nCombobox.displayName = \"Combobox\";\n";

const utilsContent = "import { clsx, type ClassValue } from 'clsx';\nimport { twMerge } from 'tailwind-merge';\n\n/**\n * Merge Tailwind CSS classes with proper precedence\n */\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs));\n}\n";

export const combobox: RegistryEntry = {
  name: "combobox",
  type: "components:ui",
  description: "Combobox component",
  dependencies: ["@ariakit/react","class-variance-authority","lucide-react","clsx","tailwind-merge"],
  registryDependencies: [],
  files: [
    {
      path: "components/ui/combobox.tsx",
      content: componentContent,
      type: "registry:ui",
      target: "components/ui/combobox.tsx"
    },
    {
      path: "lib/utils.ts",
      content: utilsContent,
      type: "registry:lib",
      target: "lib/utils.ts"
    }
  ],
  tailwind: {
    config: {
      theme: {
        extend: {}
      }
    }
  },
  meta: {
    importSpecifier: "Combobox",
    moduleSpecifier: "@/components/ui/combobox"
  }
};
